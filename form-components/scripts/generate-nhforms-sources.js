#!/usr/bin/env node
/**
 * Generate NHForms Component Sources
 *
 * This script generates a TypeScript file containing all NHForms component
 * source code as strings. This allows Next.js/webpack builds to work without
 * Vite's import.meta.glob feature.
 *
 * Run this script when:
 * - Adding a new NHForms component
 * - Modifying an existing component's source code
 *
 * Usage:
 *   node scripts/generate-nhforms-sources.js
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const nhformsDir = path.join(__dirname, '../src/nhforms');
const outputFile = path.join(nhformsDir, 'component-sources.generated.ts');

function escapeTemplateString(str) {
  // Escape backticks, ${, and backslashes for template literals
  return str
    .replace(/\\/g, '\\\\')
    .replace(/`/g, '\\`')
    .replace(/\$\{/g, '\\${');
}

function generateSources() {
  const components = [];
  const identities = [];

  // Read all component directories
  const dirs = fs.readdirSync(nhformsDir, { withFileTypes: true })
    .filter(dirent => dirent.isDirectory())
    .map(dirent => dirent.name);

  for (const dir of dirs) {
    const indexPath = path.join(nhformsDir, dir, 'index.jsx');
    const identityPath = path.join(nhformsDir, dir, 'Identity.json');

    // Read component source if it exists
    if (fs.existsSync(indexPath)) {
      const source = fs.readFileSync(indexPath, 'utf-8');
      components.push({ name: dir, source });
    }

    // Read identity if it exists
    if (fs.existsSync(identityPath)) {
      const identity = fs.readFileSync(identityPath, 'utf-8');
      identities.push({ name: dir, identity });
    }
  }

  // Generate the TypeScript file
  let output = `/**
 * AUTO-GENERATED FILE - DO NOT EDIT DIRECTLY
 *
 * Generated by: scripts/generate-nhforms-sources.js
 * Generated at: ${new Date().toISOString()}
 *
 * This file contains all NHForms component sources as strings for use
 * with Next.js/webpack builds that don't support Vite's import.meta.glob.
 *
 * To regenerate: node scripts/generate-nhforms-sources.js
 */

// Component source code (raw JSX strings)
export const componentModules: Record<string, string> = {
`;

  for (const { name, source } of components) {
    output += `  './${name}/index.jsx': \`${escapeTemplateString(source)}\`,\n`;
  }

  output += `};

// Component identities (metadata from Identity.json files)
export const componentIdentities: Record<string, any> = {
`;

  for (const { name, identity } of identities) {
    // Parse and re-stringify to ensure valid JSON and consistent formatting
    try {
      const parsed = JSON.parse(identity);
      output += `  '${name}': ${JSON.stringify(parsed, null, 2).split('\n').join('\n  ')},\n`;
    } catch (e) {
      console.warn(`Warning: Could not parse Identity.json for ${name}`);
    }
  }

  output += `};

// List of component names for iteration
export const componentNames = [
${components.map(c => `  '${c.name}',`).join('\n')}
] as const;

export type ComponentName = typeof componentNames[number];
`;

  // Write the output file
  fs.writeFileSync(outputFile, output, 'utf-8');
  console.log(`Generated ${outputFile}`);
  console.log(`  - ${components.length} component sources`);
  console.log(`  - ${identities.length} identity files`);
}

generateSources();
